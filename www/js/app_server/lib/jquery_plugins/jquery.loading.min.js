(function(e){function r(e,t){return t===undefined?t=typeof e=="boolean"?{show:e}:e:t.show=e,t&&(t.img||t.element)&&!t.pulse&&(t.pulse=!1),t&&t.onAjax!==undefined&&t.show===undefined&&(t.show=!1),t}function i(e,t){var n=e.css(t);return n=="auto"?0:parseFloat(n,10)}var t=e.loading=function(t,n){return e("body").loading(t,n,!0)};e.fn.loading=function(n,i,s){i=r(n,i);var o=s?e.extend(!0,{},t,t.pageOptions):t;return this.each(function(){var n=e(this),r=e.extend(!0,{},o,e.metadata?n.metadata():null,i);typeof r.onAjax=="boolean"?t.setAjax.call(n,r):t.toggle.call(n,r)})};var n={position:e.browser.msie?"absolute":"fixed"};e.extend(t,{version:"1.6.4",align:"top-left",pulse:"working error",mask:!1,img:null,element:null,text:"Loading...",onAjax:undefined,delay:0,max:0,classname:"loading",imgClass:"loading-img",elementClass:"loading-element",maskClass:"loading-mask",css:{position:"absolute",whiteSpace:"nowrap",zIndex:1001},maskCss:{position:"absolute",opacity:.15,background:"#333",zIndex:101,display:"block",cursor:"wait"},cloneEvents:!0,pageOptions:{page:!0,align:"top-center",css:n,maskCss:n},html:"<div></div>",maskHtml:"<div></div>",maskedClass:"loading-masked",maskEvents:"mousedown mouseup keydown keypress",resizeEvents:"resize",working:{time:1e4,text:"Still working...",run:function(e){var t=e.working,n=this;t.timeout=setTimeout(function(){n.height("auto").width("auto").text(e.text=t.text),e.place.call(n,e)},t.time)}},error:{time:1e5,text:"Task may have failed...",classname:"loading-error",run:function(e){var t=e.error,n=this;t.timeout=setTimeout(function(){n.height("auto").width("auto").text(e.text=t.text).addClass(t.classname),e.place.call(n,e)},t.time)}},fade:{time:800,speed:"slow",run:function(e){var t=e.fade,n=t.speed,r=this;t.interval=setInterval(function(){r.fadeOut(n).fadeIn(n)},t.time)}},ellipsis:{time:300,run:function(e){function r(e){var t=e.indexOf(".");return t<0?e.length:t}var t=e.ellipsis,n=this;t.interval=setInterval(function(){var t=n.text(),i=e.text,s=r(i);n.text(t.length-s<3?t+".":i.substring(0,s))},t.time)}},type:{time:100,run:function(e){var t=e.type,n=this;t.interval=setInterval(function(){var t=n.text(),r=t.length,i=e.text;n.text(r==i.length?i.charAt(0):i.substring(0,r+1))},t.time)}},toggle:function(e){var t=this.data("loading");t?e.show!==!0&&t.off.call(this,t,e):e.show!==!1&&e.on.call(this,e)},setAjax:function(e){if(e.onAjax){var t=this,n=0,r=e.ajax={start:function(){n++||e.on.call(t,e)},stop:function(){--n||e.off.call(t,e,e)}};this.bind("ajaxStart.loading",r.start).bind("ajaxStop.loading",r.stop)}else this.unbind("ajaxStart.loading ajaxStop.loading")},on:function(e,t){var n=e.parent=this.data("loading",e);e.max&&(e.maxout=setTimeout(function(){e.off.call(n,e,e)},e.max));if(e.delay&&!t)return e.timeout=setTimeout(function(){delete e.timeout,e.on.call(n,e,!0)},e.delay);e.mask&&(e.mask=e.createMask.call(n,e)),e.display=e.create.call(n,e),e.img?e.initImg.call(n,e):e.element?e.initElement.call(n,e):e.init.call(n,e),n.trigger("loadingStart",[e])},initImg:function(t){var n=this;t.imgElement=e('<img src="'+t.img+'"/>').bind("load",function(){t.init.call(n,t)}),t.display.addClass(t.imgClass).append(t.imgElement)},initElement:function(t){t.element=e(t.element).clone(t.cloneEvents).show(),t.display.addClass(t.elementClass).append(t.element),t.init.call(this,t)},init:function(e){e.place.call(e.display,e),e.pulse&&e.initPulse.call(this,e)},initPulse:function(t){e.each(t.pulse.split(" "),function(){t[this].run.call(t.display,t)})},create:function(t){var n=e(t.html).addClass(t.classname).css(t.css).appendTo(this);return t.text&&!t.img&&!t.element&&n.text(t.originalText=t.text),e(window).bind(t.resizeEvents,t.resizer=function(){t.resize(t)}),n},resize:function(e){e.parent.box=null,e.mask&&e.mask.hide(),e.place.call(e.display.hide(),e),e.mask&&e.mask.show().css(e.parent.box)},createMask:function(t){var n=t.measure.call(this.addClass(t.maskedClass),t);return t.handler=function(e){return t.maskHandler(e,t)},e(document).bind(t.maskEvents,t.handler),e(t.maskHtml).addClass(t.maskClass).css(n).css(t.maskCss).appendTo(this)},maskHandler:function(t,n){var r=e(t.target).parents().andSelf();return r.filter("."+n.classname).length!=0?!0:!n.page&&r.filter("."+n.maskedClass).length==0},place:function(t){var n=t.align,r="top",i="left";if(typeof n=="object")n=e.extend(t.calc.call(this,r,i,t),n);else{if(n!="top-left"){var s=n.split("-");s.length==1?r=i=s[0]:(r=s[0],i=s[1])}this.hasClass(r)||this.addClass(r),this.hasClass(i)||this.addClass(i),n=t.calc.call(this,r,i,t)}this.show().css(t.box=n)},calc:function(t,n,r){var s=e.extend({},r.measure.call(r.parent,r)),o=e.boxModel?this.height():this.innerHeight(),u=e.boxModel?this.width():this.innerWidth();if(t!="top"){var a=s.height-o;t=="center"?a/=2:t!="bottom"?a=0:e.boxModel&&(a-=i(this,"paddingTop")+i(this,"paddingBottom")),s.top+=a}if(n!="left"){var a=s.width-u;n=="center"?a/=2:n!="right"?a=0:e.boxModel&&(a-=i(this,"paddingLeft")+i(this,"paddingRight")),s.left+=a}return s.height=o,s.width=u,s},measure:function(e){return this.box||(this.box=e.page?e.pageBox(e):e.elementBox(this,e))},elementBox:function(e,t){if(e.css("position")=="absolute")var n={top:0,left:0};else{var n=e.position();n.top+=i(e,"marginTop"),n.left+=i(e,"marginLeft")}return n.height=e.outerHeight(),n.width=e.outerWidth(),n},pageBox:function(t){function r(t,n){var r=document;if(t){var s=n.toLowerCase(),o=e(r)[s](),u=e(window)[s]();return o-i(e(r.body),"marginTop")>u?o:u}var a="client"+n;return Math.max(r.documentElement[a],r.body[a])}var n=e.boxModel&&t.css.position!="fixed";return{top:0,left:0,height:r(n,"Height"),width:r(n,"Width")}},off:function(t,n){this.data("loading",null),t.maxout&&clearTimeout(t.maxout);if(t.timeout)return clearTimeout(t.timeout);t.pulse&&t.stopPulse.call(this,t,n),t.originalText&&(t.text=t.originalText),t.mask&&t.stopMask.call(this,t,n),e(window).unbind(t.resizeEvents,t.resizer),t.display&&t.display.remove(),t.parent&&t.parent.trigger("loadingEnd",[t])},stopPulse:function(t,n){e.each(t.pulse.split(" "),function(){var e=t[this];e.end&&e.end.call(n.display,t,n),e.interval&&clearInterval(e.interval),e.timeout&&clearTimeout(e.timeout)})},stopMask:function(t,n){this.removeClass(n.maskedClass),e(document).unbind(t.maskEvents,t.handler),t.mask.remove()}})})(jQuery);